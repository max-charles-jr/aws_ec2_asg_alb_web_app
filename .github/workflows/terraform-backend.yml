name: Setup Terraform Backend (S3 + DynamoDB)

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: 'AWS Region'
        required: true
        type: string
        default: 'us-east-1'
      project_name:
        description: 'Project name (used in bucket naming)'
        required: true
        type: string
        default: 'myapp'
      environments:
        description: 'Environments to create (comma-separated)'
        required: true
        type: string
        default: 'dev,qa,prod'
      use_oidc:
        description: 'Use OIDC authentication (recommended)'
        required: true
        type: boolean
        default: true

jobs:
  setup-backend:
    name: 'Setup Terraform Backend'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Parse Environments
        id: parse-envs
        run: |
          ENVS="${{ github.event.inputs.environments }}"
          ENVS=$(echo $ENVS | tr ',' ' ')
          echo "environments=$ENVS" >> $GITHUB_OUTPUT
          echo "Environments to setup: $ENVS"
      
      - name: Configure AWS Credentials (OIDC)
        if: github.event.inputs.use_oidc == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ github.event.inputs.aws_region }}
      
      - name: Configure AWS Credentials (Access Keys)
        if: github.event.inputs.use_oidc == 'false'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.TEMP_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.TEMP_AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.TEMP_AWS_SESSION_TOKEN }}
          aws-region: ${{ github.event.inputs.aws_region }}
      
      - name: Verify AWS Authentication
        run: |
          echo "ðŸ” Verifying AWS authentication..."
          aws sts get-caller-identity
          echo "âœ… Authentication successful"
      
      - name: Create S3 Buckets and DynamoDB Tables
        id: create-resources
        run: |
          PROJECT_NAME="${{ github.event.inputs.project_name }}"
          REGION="${{ github.event.inputs.aws_region }}"
          ENVS="${{ steps.parse-envs.outputs.environments }}"
          
          echo "## Resource Creation Summary" > summary.md
          echo "" >> summary.md
          echo "| Environment | S3 Bucket | DynamoDB Table | Status |" >> summary.md
          echo "|-------------|-----------|----------------|--------|" >> summary.md
          
          for ENV in $ENVS; do
            echo ""
            echo "=================================================="
            echo "Setting up backend for environment: $ENV"
            echo "=================================================="
            
            BUCKET_NAME="${PROJECT_NAME}-terraform-state-${ENV}"
            TABLE_NAME="terraform-state-lock-${ENV}"
            
            # Create S3 Bucket
            echo "ðŸ“¦ Creating S3 bucket: $BUCKET_NAME"
            
            set +e
            if aws s3 ls "s3://${BUCKET_NAME}" 2>/dev/null; then
              echo "âš ï¸  Bucket already exists: $BUCKET_NAME"
              BUCKET_STATUS="Already Exists"
            else
              if [ "$REGION" == "us-east-1" ]; then
                aws s3api create-bucket \
                  --bucket "${BUCKET_NAME}" \
                  --region "${REGION}"
              else
                aws s3api create-bucket \
                  --bucket "${BUCKET_NAME}" \
                  --region "${REGION}" \
                  --create-bucket-configuration LocationConstraint="${REGION}"
              fi
              
              if [ $? -eq 0 ]; then
                echo "âœ… Bucket created: $BUCKET_NAME"
                BUCKET_STATUS="Created"
              else
                echo "âŒ Failed to create bucket: $BUCKET_NAME"
                BUCKET_STATUS="Failed"
              fi
            fi
            set -e
            
            # Enable versioning
            echo "ðŸ”„ Enabling versioning on $BUCKET_NAME"
            aws s3api put-bucket-versioning \
              --bucket "${BUCKET_NAME}" \
              --versioning-configuration Status=Enabled
            
            # Enable encryption
            echo "ðŸ”’ Enabling encryption on $BUCKET_NAME"
            aws s3api put-bucket-encryption \
              --bucket "${BUCKET_NAME}" \
              --server-side-encryption-configuration '{
                "Rules": [{
                  "ApplyServerSideEncryptionByDefault": {
                    "SSEAlgorithm": "AES256"
                  },
                  "BucketKeyEnabled": true
                }]
              }'
            
            # Block public access
            echo "ðŸš« Blocking public access on $BUCKET_NAME"
            aws s3api put-public-access-block \
              --bucket "${BUCKET_NAME}" \
              --public-access-block-configuration \
              "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
            
            # Add bucket policy for SSL-only access
            echo "ðŸ” Adding bucket policy for SSL-only access"
            cat > bucket-policy.json <<EOF
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "DenyInsecureTransport",
                  "Effect": "Deny",
                  "Principal": "*",
                  "Action": "s3:*",
                  "Resource": [
                    "arn:aws:s3:::${BUCKET_NAME}",
                    "arn:aws:s3:::${BUCKET_NAME}/*"
                  ],
                  "Condition": {
                    "Bool": {
                      "aws:SecureTransport": "false"
                    }
                  }
                }
              ]
            }
            EOF
            
            aws s3api put-bucket-policy \
              --bucket "${BUCKET_NAME}" \
              --policy file://bucket-policy.json
            
            # Add lifecycle policy to clean up old versions
            echo "â™»ï¸  Adding lifecycle policy"
            cat > lifecycle-policy.json <<EOF
            {
              "Rules": [
                {
                  "Id": "DeleteOldVersions",
                  "Status": "Enabled",
                  "NoncurrentVersionExpiration": {
                    "NoncurrentDays": 90
                  }
                }
              ]
            }
            EOF
            
            aws s3api put-bucket-lifecycle-configuration \
              --bucket "${BUCKET_NAME}" \
              --lifecycle-configuration file://lifecycle-policy.json
            
            # Tag the bucket
            echo "ðŸ·ï¸  Tagging S3 bucket"
            aws s3api put-bucket-tagging \
              --bucket "${BUCKET_NAME}" \
              --tagging "TagSet=[
                {Key=Environment,Value=${ENV}},
                {Key=Project,Value=${PROJECT_NAME}},
                {Key=ManagedBy,Value=GitHub-Actions},
                {Key=Purpose,Value=TerraformState}
              ]"
            
            # Create DynamoDB Table
            echo "ðŸ—„ï¸  Creating DynamoDB table: $TABLE_NAME"
            
            set +e
            aws dynamodb describe-table --table-name "${TABLE_NAME}" --region "${REGION}" 2>/dev/null
            if [ $? -eq 0 ]; then
              echo "âš ï¸  Table already exists: $TABLE_NAME"
              TABLE_STATUS="Already Exists"
            else
              aws dynamodb create-table \
                --table-name "${TABLE_NAME}" \
                --attribute-definitions AttributeName=LockID,AttributeType=S \
                --key-schema AttributeName=LockID,KeyType=HASH \
                --billing-mode PAY_PER_REQUEST \
                --region "${REGION}" \
                --tags Key=Environment,Value=${ENV} Key=Project,Value=${PROJECT_NAME} Key=ManagedBy,Value=GitHub-Actions Key=Purpose,Value=TerraformStateLock
              
              if [ $? -eq 0 ]; then
                echo "âœ… Table created: $TABLE_NAME"
                TABLE_STATUS="Created"
                
                # Wait for table to be active
                echo "â³ Waiting for table to be active..."
                aws dynamodb wait table-exists --table-name "${TABLE_NAME}" --region "${REGION}"
              else
                echo "âŒ Failed to create table: $TABLE_NAME"
                TABLE_STATUS="Failed"
              fi
            fi
            set -e
            
            # Enable Point-in-Time Recovery
            echo "ðŸ’¾ Enabling Point-in-Time Recovery on $TABLE_NAME"
            aws dynamodb update-continuous-backups \
              --table-name "${TABLE_NAME}" \
              --point-in-time-recovery-specification PointInTimeRecoveryEnabled=true \
              --region "${REGION}"
            
            # Add to summary
            if [ "$BUCKET_STATUS" == "Failed" ] || [ "$TABLE_STATUS" == "Failed" ]; then
              OVERALL_STATUS="âŒ Failed"
            elif [ "$BUCKET_STATUS" == "Already Exists" ] && [ "$TABLE_STATUS" == "Already Exists" ]; then
              OVERALL_STATUS="âš ï¸  Existing"
            else
              OVERALL_STATUS="âœ… Success"
            fi
            
            echo "| $ENV | \`$BUCKET_NAME\` | \`$TABLE_NAME\` | $OVERALL_STATUS |" >> summary.md
            
            echo ""
            echo "âœ… Completed setup for environment: $ENV"
          done
          
          echo "" >> summary.md
          echo "" >> summary.md
          echo "### Backend Configuration" >> summary.md
          echo "" >> summary.md
          echo "Use these backend configurations in your Terraform code:" >> summary.md
          echo "" >> summary.md
          
          for ENV in $ENVS; do
            BUCKET_NAME="${PROJECT_NAME}-terraform-state-${ENV}"
            TABLE_NAME="terraform-state-lock-${ENV}"
            
            echo "**$ENV Environment:**" >> summary.md
            echo '```hcl' >> summary.md
            echo 'terraform {' >> summary.md
            echo '  backend "s3" {' >> summary.md
            echo "    bucket         = \"${BUCKET_NAME}\"" >> summary.md
            echo "    key            = \"autoscaling/${ENV}/terraform.tfstate\"" >> summary.md
            echo "    region         = \"${REGION}\"" >> summary.md
            echo '    encrypt        = true' >> summary.md
            echo "    dynamodb_table = \"${TABLE_NAME}\"" >> summary.md
            echo '  }' >> summary.md
            echo '}' >> summary.md
            echo '```' >> summary.md
            echo "" >> summary.md
          done
      
      - name: Generate Summary
        run: |
          echo "# ðŸŽ‰ Terraform Backend Setup Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat summary.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Verify resources** in AWS Console" >> $GITHUB_STEP_SUMMARY
          echo "2. **Update \`backend.tf\`** in your Terraform code" >> $GITHUB_STEP_SUMMARY
          echo "3. **Run \`terraform init\`** to initialize the backend" >> $GITHUB_STEP_SUMMARY
          echo "4. **Remove temporary credentials** if you used access keys" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Security Features Enabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Server-side encryption (AES-256)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Versioning enabled" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Public access blocked" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SSL-only access enforced" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… DynamoDB Point-in-Time Recovery" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Lifecycle policy for old versions" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Configuration Files
        uses: actions/upload-artifact@v4
        with:
          name: backend-configurations
          path: |
            summary.md
            bucket-policy.json
            lifecycle-policy.json
          retention-days: 30